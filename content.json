{"meta":{"title":"程序猿小站","subtitle":null,"description":null,"author":"橘子","url":"http://yoursite.com"},"pages":[{"title":"categories","date":"2018-11-21T09:59:19.000Z","updated":"2018-11-21T09:59:57.668Z","comments":false,"path":"categories/index.html","permalink":"http://yoursite.com/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2018-11-21T09:59:22.000Z","updated":"2018-11-21T09:59:43.575Z","comments":false,"path":"tags/index.html","permalink":"http://yoursite.com/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Elasticsearch-6.2.4插件开发二：插件的加载过程","slug":"Elasticsearch-6.2.4插件开发二：插件的加载过程","date":"2018-11-22T03:20:17.736Z","updated":"2018-11-22T03:21:48.705Z","comments":true,"path":"2018/11/22/Elasticsearch-6.2.4插件开发二：插件的加载过程/","link":"","permalink":"http://yoursite.com/2018/11/22/Elasticsearch-6.2.4插件开发二：插件的加载过程/","excerpt":"","text":"1. 从源码看插件的加载过程插件是在节点初始化的时候加载的，下面列举出部分关键代码，以搜索服务为例来介绍插件的加载过程： 1234567891011121314151617181920212223242526272829public Node(Environment environment) &#123; this(environment, Collections.emptyList());&#125;protected Node(final Environment environment, Collection&lt;Class&lt;? extends Plugin&gt;&gt; classpathPlugins) &#123; ...... // 插件服务从以下几个地方加载插件：plugins和modules文件夹、classpathPlugins集合（集合为空，可在开发时使用） this.pluginsService = new PluginsService(tmpSettings, environment.configFile(), environment.modulesFile(), environment.pluginsFile(), classpathPlugins); ...... // 初始化search模块，可以看到实现SearchPlugin接口的插件类将会被过滤出来 SearchModule searchModule = new SearchModule(settings, false, pluginsService.filterPlugins(SearchPlugin.class)); ...... // 各个模块整合成搜索服务searchService final SearchService searchService = newSearchService(clusterService, indicesService, threadPool, scriptModule.getScriptService(), bigArrays, searchModule.getFetchPhase(), responseCollectorService); ...... modules.add(b -&gt; &#123; ...... // 注入实例 b.bind(SearchPhaseController.class).toInstance(new SearchPhaseController(settings, searchService::createReduceContext)); ...... &#125; ......&#125; 接着我们来看pluginsService的构造函数： 1234567public PluginsService(Settings settings, Path configPath, Path modulesDirectory, Path pluginsDirectory, Collection&lt;Class&lt;? extends Plugin&gt;&gt; classpathPlugins) &#123; ...... // 以classpathPlugins的形式作为参考，可以看到需要继承Plugin抽象类 for (Class&lt;? extends Plugin&gt; pluginClass : classpathPlugins) &#123; ...... &#125;&#125; 可以看出，首先，我们要有一个类继承Plugin类并且某些服务需要实现相应的插件接口（旧版es只需要继承Plugin便可修改各个模块，相关接口现已弃用）才能被发现。 2. 搜索插件的加载过程接下来我们以搜索插件中的高亮部分为例，看看如何以插件的形式给es添加新的高亮类型。 首先是searchModule的构造函数： 可以看到构造函数中注册了各种搜索模块，而其中就有高亮的注册。 首先加载了3个系统自带的高亮类型，然后加载搜索插件中的高亮部分。","categories":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/categories/Elasticsearch/"}],"tags":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/tags/Elasticsearch/"}]},{"title":"Elasticsearch-6.2.4插件开发一：插件种类介绍","slug":"Elasticsearch-6.2.4插件开发一：插件种类介绍","date":"2018-11-22T03:03:01.969Z","updated":"2018-11-22T03:08:12.009Z","comments":true,"path":"2018/11/22/Elasticsearch-6.2.4插件开发一：插件种类介绍/","link":"","permalink":"http://yoursite.com/2018/11/22/Elasticsearch-6.2.4插件开发一：插件种类介绍/","excerpt":"","text":"1. 插件开发ES提供两种方式用于插件开发，一种是继承Plugin抽象类，一种是继承Plugin抽象类后再实现相关的插件接口。 2. 插件种类ScriptPlugin：脚本插件，ES默认的脚本语言是Painless，可自定义其他脚本语言，java、js等。 AnalysisPlugin：分析插件，可扩展新的分析器，标记器，标记过滤器或字符过滤器等。 DiscoveryPlugin：发现插件，使集群可以发现节点，如使建立在AWS上的集群可以发现节点。 ClusterPlugin：集群插件，增强对集群的管理，如控制分片位置。 IngestPlugin：摄取插件，增强节点的ingest功能，例如可以在ingest中通过tika解析ppt、pdf内容。 MapperPlugin：映射插件，可添加新的字段类型。 SearchPlugin：搜索插件，扩展搜索功能，如添加新的搜索类型，高亮类型等。 RepositoryPlugin：存储库插件，可添加新的存储库，如S3，Hadoop HDFS等。 ActionPlugin：API扩展插件，可扩展Http的API接口。 NetworkPlugin：网络插件，扩展ES底层的网络传输功能。 除了明确属于不同模块的插件接口外，继承抽象类Plugin可以为索引模块添加新的功能，如添加索引、搜索监听器，新的相似度算法。","categories":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/categories/Elasticsearch/"}],"tags":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/tags/Elasticsearch/"}]},{"title":"Elasticsearch-6.2.4源码启动（window环境下）","slug":"Elasticsearch-6.2.4源码启动（window环境下）","date":"2018-11-22T02:37:37.120Z","updated":"2018-11-22T03:08:26.208Z","comments":true,"path":"2018/11/22/Elasticsearch-6.2.4源码启动（window环境下）/","link":"","permalink":"http://yoursite.com/2018/11/22/Elasticsearch-6.2.4源码启动（window环境下）/","excerpt":"","text":"1. 获取源码和可运行的es1.1 首先从github上把es的源码拉下来并切换分支到v6.2.4版本（ps：es不同版本源码启动过程差异可能较大）。 1git clone https://github.com/elastic/elasticsearch.git 1git checkout v6.2.4 （本篇博客命令执行皆使用git bash） 1.2 到官网下载可运行的es 2. 编译源码es是一个gradle项目，导入idea前需执行gradle idea命令，不然会报错。 使用项目自带的gradlew编译es源码 ./gradlew idea ./gradlew build （IDE是eclipse的话则将命令中idea替换成eclipse） 编译完成后便可用idea打开项目。 3. 运行es如何从源码运行es？ 我们先参考官网下载的es中，bin目录下的启动脚本elasticsearch，elasticsearch-env 123456789101112(只列出关键部分，其余省略)SCRIPT=&quot;$0&quot;ES_HOME=`dirname &quot;$SCRIPT&quot;`ES_PATH_CONF=&quot;$ES_HOME&quot;/config......&quot;$JAVA&quot; \\$ES_JAVA_OPTS \\-Des.path.home=&quot;$ES_HOME&quot; \\-Des.path.conf=&quot;$ES_PATH_CONF&quot; \\-cp &quot;$ES_CLASSPATH&quot; \\org.elasticsearch.bootstrap.Elasticsearch \\...... 可见，es的启动入口为org.elasticsearch.bootstrap.Elasticsearch； es启动需要配置两个启动参数es.path.home和es.path.conf 其中es.path.home是es服务的路径，即es项目中server目录下，es.path.conf为配置文件目录，在server目录下创建config文件夹作为配置文件目录，并直接从官网的es中copy三个配置文件（此处不详解文件具体内容）。 打开idea配置两个启动参数（直接绝对路径即可） 12-Des.path.conf=E:\\......\\elasticsearch\\server\\config-Des.path.home=E:\\......\\elasticsearch\\server 在idea顶层菜单打开Run&gt;Edit Configurations，配置VM options 接下来我们启动试一试：src&gt;main&gt;java&gt;org&gt;elasticsearch&gt;bootstrap&gt;Elasticsearch 直接执行main方法，发现启动失败，出现几个异常： 第一个 原因是es启动时会去扫描主目录下的plugins目录，加载es插件（插件方面将在其他文章说明），所以要创建plugins目录。 第二个 原因是用户没有操作目录的权限 直接在server目录下建立java.policy文件： 123456789grant codeBase &quot;file:$&#123;&#123;java.ext.dirs&#125;&#125;/*&quot; &#123; permission java.security.AllPermission; permission java.lang.RuntimePermission &quot;createClassLoader&quot;;&#125;;grant &#123; permission java.security.AllPermission; permission java.lang.RuntimePermission &quot;createClassLoader&quot;;&#125;; VM options的配置增加： 123-Des.path.conf=E:\\......\\elasticsearch\\server\\config-Des.path.home=E:\\......\\elasticsearch\\server-Djava.security.policy=E:\\......\\elasticsearch\\server\\java.policy 第三个 原因是相关模块的缺失，es加载为空，直接把官网的es中的modules文件夹整个复制到server目录下就行。 第四个 ExtendedPluginsClassLoader这个类并没有编译出来 至于原因，我们可以在单元测试类BootstrapForTesting中看到这一段： 原来eclipse和idea并不会打包内置的依赖，即传递依赖： 可以看到plugin-classloader的编译类型是compileOnly和testRuntime，只在编译阶段编译，在运行阶段不会将这个依赖包括进来，idea是默认不会运行时不包括传递依赖的，可以在这里勾选设置启动将包括该类传递依赖 所有问题解决后便可以顺利启动了。","categories":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/categories/Elasticsearch/"}],"tags":[{"name":"Elasticsearch","slug":"Elasticsearch","permalink":"http://yoursite.com/tags/Elasticsearch/"}]}]}