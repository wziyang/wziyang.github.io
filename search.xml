<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Elasticsearch-6.2.4源码启动（window环境下）</title>
      <link href="/2018/11/22/Elasticsearch-6.2.4%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%EF%BC%88window%E7%8E%AF%E5%A2%83%E4%B8%8B%EF%BC%89/"/>
      <url>/2018/11/22/Elasticsearch-6.2.4%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%EF%BC%88window%E7%8E%AF%E5%A2%83%E4%B8%8B%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="Elasticsearch-6-2-4源码启动（window环境下）"><a href="#Elasticsearch-6-2-4源码启动（window环境下）" class="headerlink" title="Elasticsearch-6.2.4源码启动（window环境下）"></a>Elasticsearch-6.2.4源码启动（window环境下）</h1><h2 id="1-获取源码和可运行的es"><a href="#1-获取源码和可运行的es" class="headerlink" title="1. 获取源码和可运行的es"></a>1. 获取源码和可运行的es</h2><p>1.1 首先从github上把es的源码拉下来并切换分支到v6.2.4版本（ps：es不同版本源码启动过程差异可能较大）。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/elastic/elasticsearch.git</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout v6.2.4</span><br></pre></td></tr></table></figure><p>（本篇博客命令执行皆使用git bash）</p><p>1.2 到官网下载可运行的es</p><h2 id="2-编译源码"><a href="#2-编译源码" class="headerlink" title="2. 编译源码"></a>2. 编译源码</h2><p>es是一个gradle项目，导入idea前需执行<code>gradle idea</code>命令，不然会报错。</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/gradle_idea%E6%8A%A5%E9%94%99.png" alt="img"></p><p>使用项目自带的gradlew编译es源码</p><p>./gradlew idea</p><p>./gradlew build</p><p>（IDE是eclipse的话则将命令中idea替换成eclipse）</p><p>编译完成后便可用idea打开项目。</p><h2 id="3-运行es"><a href="#3-运行es" class="headerlink" title="3. 运行es"></a>3. 运行es</h2><p>如何从源码运行es？</p><p>我们先参考官网下载的es中，bin目录下的启动脚本elasticsearch，elasticsearch-env</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(只列出关键部分，其余省略)</span><br><span class="line">SCRIPT=&quot;$0&quot;</span><br><span class="line">ES_HOME=`dirname &quot;$SCRIPT&quot;`</span><br><span class="line">ES_PATH_CONF=&quot;$ES_HOME&quot;/config</span><br><span class="line">......</span><br><span class="line">&quot;$JAVA&quot; \</span><br><span class="line">$ES_JAVA_OPTS \</span><br><span class="line">-Des.path.home=&quot;$ES_HOME&quot; \</span><br><span class="line">-Des.path.conf=&quot;$ES_PATH_CONF&quot; \</span><br><span class="line">-cp &quot;$ES_CLASSPATH&quot; \</span><br><span class="line">org.elasticsearch.bootstrap.Elasticsearch \</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>可见，es的启动入口为org.elasticsearch.bootstrap.Elasticsearch；</p><p>es启动需要配置两个启动参数es.path.home和es.path.conf</p><p>其中es.path.home是es服务的路径，即es项目中server目录下，es.path.conf为配置文件目录，在server目录下创建config文件夹作为配置文件目录，并直接从官网的es中copy三个配置文件（此处不详解文件具体内容）。</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/config目录下文件.png" alt="img"></p><p>打开idea配置两个启动参数（直接绝对路径即可）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Des.path.conf=E:\......\elasticsearch\server\config</span><br><span class="line">-Des.path.home=E:\......\elasticsearch\server</span><br></pre></td></tr></table></figure><p>在idea顶层菜单打开Run&gt;Edit Configurations，配置VM options</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/配置两个路径.png" alt="img"></p><p>接下来我们启动试一试：src&gt;main&gt;java&gt;org&gt;elasticsearch&gt;bootstrap&gt;Elasticsearch</p><p>直接执行main方法，发现启动失败，出现几个异常：</p><p>第一个</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/没有plugin目录.png" alt="img"></p><p>原因是es启动时会去扫描主目录下的plugins目录，加载es插件（插件方面将在其他文章说明），所以要创建plugins目录。</p><p>第二个</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/权限问题.png" alt="img"></p><p>原因是用户没有操作目录的权限</p><p>直接在server目录下建立java.policy文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">grant codeBase &quot;file:$&#123;&#123;java.ext.dirs&#125;&#125;/*&quot; &#123;</span><br><span class="line">        permission java.security.AllPermission;</span><br><span class="line">        permission java.lang.RuntimePermission &quot;createClassLoader&quot;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">grant &#123;</span><br><span class="line">        permission java.security.AllPermission;</span><br><span class="line">        permission java.lang.RuntimePermission &quot;createClassLoader&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>VM options的配置增加：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Des.path.conf=E:\......\elasticsearch\server\config</span><br><span class="line">-Des.path.home=E:\......\elasticsearch\server</span><br><span class="line">-Djava.security.policy=E:\......\elasticsearch\server\java.policy</span><br></pre></td></tr></table></figure><p>第三个</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/module缺失.png" alt="img"></p><p>原因是相关模块的缺失，es加载为空，直接把官网的es中的modules文件夹整个复制到server目录下就行。</p><p>第四个</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/类没有.png" alt="img"></p><p>ExtendedPluginsClassLoader这个类并没有编译出来</p><p>至于原因，我们可以在单元测试类BootstrapForTesting中看到这一段：</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/classloader没编译.png" alt="img"> 原来eclipse和idea并不会打包内置的依赖，即传递依赖：</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/compileonly编译.png" alt="img"></p><p>可以看到plugin-classloader的编译类型是compileOnly和testRuntime，只在编译阶段编译，在运行阶段不会将这个依赖包括进来，idea是默认不会运行时不包括传递依赖的，可以在这里勾选设置启动将包括该类传递依赖</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/勾选设置.png" alt="img"></p><p>所有问题解决后便可以顺利启动了。</p><p><img src="http://www.wziyang.cn/wordpress/wp-content/uploads/2018/09/启动成功.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> Elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
